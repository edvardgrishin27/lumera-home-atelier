name: Health Check Monitor

on:
  schedule:
    # Every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Check site availability
        id: site
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://lumerahome.ru/ 2>/dev/null || echo "000")
          echo "status=$HTTP_STATUS" >> "$GITHUB_OUTPUT"
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "site_down=true" >> "$GITHUB_OUTPUT"
          else
            echo "site_down=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check API health
        id: api
        run: |
          RESPONSE=$(curl -s --max-time 10 https://lumerahome.ru/api/health 2>/dev/null || echo '{"ok":false}')
          echo "response=$RESPONSE" >> "$GITHUB_OUTPUT"
          API_OK=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('ok', False))" 2>/dev/null || echo "False")
          if [ "$API_OK" = "True" ]; then
            echo "api_down=false" >> "$GITHUB_OUTPUT"
          else
            echo "api_down=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create alert issue if down
        if: steps.site.outputs.site_down == 'true' || steps.api.outputs.api_down == 'true'
        uses: actions/github-script@v7
        env:
          SITE_STATUS: ${{ steps.site.outputs.status }}
          API_DOWN: ${{ steps.api.outputs.api_down }}
          API_RESPONSE: ${{ steps.api.outputs.response }}
        with:
          script: |
            const siteStatus = process.env.SITE_STATUS;
            const apiDown = process.env.API_DOWN;
            const apiResponse = process.env.API_RESPONSE;

            // Check if there's already an open alert issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'alert:downtime',
              state: 'open',
            });

            if (issues.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `‚ö†Ô∏è Still down at ${new Date().toISOString()}\n- Site HTTP: ${siteStatus}\n- API healthy: ${apiDown === 'false' ? '‚úÖ' : '‚ùå'}`,
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üö® Site DOWN ‚Äî HTTP ${siteStatus}`,
                body: [
                  '## Alert: lumerahome.ru is down\n',
                  `- **Time:** ${new Date().toISOString()}`,
                  `- **Site HTTP status:** ${siteStatus}`,
                  `- **API healthy:** ${apiDown === 'false' ? '‚úÖ' : '‚ùå'}`,
                  '',
                  '### Next steps',
                  '1. SSH to VPS: `docker compose logs api --tail 50`',
                  '2. Check containers: `docker compose ps`',
                  '3. Restart if needed: `docker compose up -d --build`',
                  '',
                  '---',
                  '*Auto-generated by health-check workflow*',
                ].join('\n'),
                labels: ['alert:downtime'],
              });
            }

      - name: Auto-close alert if recovered
        if: steps.site.outputs.site_down == 'false' && steps.api.outputs.api_down == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'alert:downtime',
              state: 'open',
            });

            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚úÖ **Recovered** at ${new Date().toISOString()}\n\nSite is back up. Closing this alert.`,
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
              });
            }
